<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>
 	<import resource="classpath:alfresco/public-services-security-context.xml"/>
 	
 	<bean id="ServiceRegistry" class="org.alfresco.repo.service.ServiceDescriptorRegistry" />
    <bean id="exceptionTranslator" class="org.alfresco.repo.security.permissions.impl.ExceptionTranslatorMethodInterceptor"/>

 	<bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>classpath*:META-INF/spring/*.properties</value>
				<value>classpath*:alfresco/extensions/advanced-workflow.properties</value>
			</list>
		</property>
		<property name="ignoreUnresolvablePlaceholders" value="true" />
	</bean>

    <bean id="WorkflowService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <value>it.cnr.alfresco.repo.workflow.WorkflowService</value>
        </property>
        <property name="target">
            <ref bean="WorkflowServiceImpl"/>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="WorkflowService_transaction"/>
                <idref local="AuditMethodInterceptor"/>
                <idref local="exceptionTranslator"/>
                 <idref bean="WorkflowService_security"/>
            </list>
        </property>
    </bean>
    <bean id="WorkflowService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>
    <bean id="AuditMethodInterceptor" class="org.alfresco.repo.audit.AuditMethodInterceptor">
        
        <!-- EDGARDO: Fino alla versione 3.3.5 di alfresco il bean aveva il nome publicServiceIdentifier
        <property name="publicServiceIdentifier">
            <ref bean="publicServiceIdentifier"/>
        </property>
         -->
        <!-- EDGARDO: Dalla versione 3.4 di alfresco il bean ha il nome beanIdentifier -->
        <property name="beanIdentifier">
            <ref bean="beanIdentifier"/>
        </property>
        
        
        <property name="auditComponent">
            <ref bean="auditComponent"/>
        </property>
        <property name="transactionService">
            <ref bean="transactionService"/>
        </property>
    </bean>
    
    
   <bean id="WorkflowServiceImpl" class="it.cnr.alfresco.repo.workflow.WorkflowServiceImpl">
      <property name="authorityService" ref="authorityService"/>
      <property name="BPMEngineRegistry" ref="bpm_engineRegistry"/>
      <property name="BPMEngineRegistryCNR" ref="bpm_engineRegistry"/>
      
      <!-- EDGARDO: Il seguente blocco serve per la release 4.0 di alfresco enterprise -->
	  <property name="services" ref="ServiceRegistry"/>
	  <property name="workflowAdminService" ref="workflowAdminService"/>
      <!-- EDGARDO-->
            
      <property name="workflowPackageComponent" ref="workflowPackageImpl"/>
      <property name="nodeService" ref="nodeService"/>
      <property name="contentService" ref="contentService"/>
	  <property name="avmSyncService" ref="AVMSyncService"/>
	  <property name="dictionaryService" ref="dictionaryService"/>
	  <property name="protectedNodeService" ref="NodeService"/>
   </bean>
  <bean id="jbpm_engine" class="it.cnr.alfresco.repo.workflow.JBPMEngine" parent="bpm_engine">
      <property name="engineId" value="jbpm"/>
      <property name="JBPMTemplate" ref="jbpm_template"/>
      <property name="dictionaryService" ref="DictionaryService"/>
      <property name="namespaceService" ref="namespaceService"/>
      <property name="nodeService" ref="nodeService"/>
      <property name="tenantService" ref="tenantService"/>
      <property name="tenantServiceCNR" ref="tenantService"/>

      <property name="messageService" ref="messageService"/>
      <property name="personService" ref="personService"/>
      <property name="authorityDAO" ref="authorityDAO"/>
      <!-- Creates JBPMNodes (ScriptNodes) which require the ServiceRegsitry -->
      <property name="serviceRegistry" ref="ServiceRegistry"/>
      <property name="companyHomeStore"><value>${spaces.store}</value></property>
      <property name="companyHomePath"><value>/${spaces.company_home.childname}</value></property>
	  <property name="unprotectedSearchService" ref="searchService"/>
   </bean>




   <!-- EDGARDO -->
    
    <bean id="webscript.it.cnr.alfresco.repository.workflow.process-list.get" 
          class="it.cnr.alfresco.repository.workflow.ProcessList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>
	  <property name="preferenceService" ref="PreferenceService"/>                
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.process-undef.get" 
          class="it.cnr.alfresco.repository.workflow.ProcessUndef"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.process-def.post" 
          class="it.cnr.alfresco.repository.workflow.ProcessDeploy"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.activeInstances.get" 
          class="it.cnr.alfresco.repository.workflow.ActiveInstanceList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.start-workflow.get" 
          class="it.cnr.alfresco.repository.workflow.StartTask"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.deftasklist.get" 
          class="it.cnr.alfresco.repository.workflow.DefTaskList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>
      <property name="DOT">
            <value>${graphviz.filter.command}</value>
      </property>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.task-list.get" 
          class="it.cnr.alfresco.repository.workflow.TaskList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
        <bean id="webscript.it.cnr.alfresco.repository.workflow.task-filtered-list.get" 
          class="it.cnr.alfresco.repository.workflow.TaskFilteredList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.package-list.get" 
          class="it.cnr.alfresco.repository.workflow.PackageList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.transition-list.get" 
          class="it.cnr.alfresco.repository.workflow.TransitionList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.end-instance.post" 
          class="it.cnr.alfresco.repository.workflow.EndInstance"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.pathInstances.get" 
          class="it.cnr.alfresco.repository.workflow.PathList"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.task-parameters.post" 
          class="it.cnr.alfresco.repository.workflow.TaskParameters"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.task-documents.post" 
          class="it.cnr.alfresco.repository.workflow.TaskDocuments"
          parent="webscript">
      <property name="workflowService" ref="WorkflowService"/>
      <property name="serviceRegistry" ref="ServiceRegistry"/>          
    </bean>
    
    <bean id="webscript.it.cnr.alfresco.repository.workflow.task-instances.get"
          class="it.cnr.alfresco.repository.workflow.TaskInstancesGet"
          parent="abstractWorkflowWebScript">
          
          <!-- EDGARDO: Dalla versione 3.4 di alfresco deve essere presente anche la seguente proprietà -->
          <property name="serviceRegistry" ref="ServiceRegistry"/>
    </bean>
    <bean id="webscript.it.cnr.alfresco.repository.workflow.status-list.get"
          class="it.cnr.alfresco.repository.workflow.TaskInstancesGet"
          parent="abstractWorkflowWebScript">
          
          <!-- EDGARDO: Dalla versione 3.4 di alfresco deve essere presente anche la seguente proprietà -->
          <property name="serviceRegistry" ref="ServiceRegistry"/>
    </bean>
    
    <bean id="abstractWorkflowWebScript"
          class="org.alfresco.repo.web.scripts.rule.AbstractRuleWebScript"
          parent="webscript" abstract="true">
        <property name="namespaceService" ref="NamespaceService" />
        <property name="nodeService" ref="NodeService"/>
        <property name="personService" ref="PersonService"/>
        <property name="workflowService" ref="WorkflowService"/>
        <property name="serviceRegistry" ref="ServiceRegistry"/>
    </bean>


    
<!--EDGARDO-->    
</beans>
